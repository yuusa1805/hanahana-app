<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ãƒãƒŠãƒãƒŠè¨­å®šåˆ¤åˆ¥</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f5f5f5;
  padding: 20px;
}
h1 { text-align: center; }

select, input, button {
  width: 100%;
  padding: 14px;
  margin-top: 10px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

button.save {
  background: #ff5a5a;
  color: white;
  border: none;
}
button.clear {
  background: #888;
  color: white;
  border: none;
}

.card {
  background: white;
  padding: 15px;
  border-radius: 10px;
  margin-top: 15px;
  border: 2px solid transparent;
}
.aim {
  border-color: red;
  background: #fff0f0;
}
.aim-label {
  color: red;
  font-weight: bold;
  margin-top: 6px;
}
.red { color: red; font-weight: bold; }
.gray { color: #777; }
.small { font-size: 13px; color: #666; }
</style>
</head>

<body>
<h1>ãƒãƒŠãƒãƒŠè¨­å®šåˆ¤åˆ¥</h1>

<select id="mode" onchange="render()">
  <option value="open">å–¶æ¥­ä¸­ãƒ¢ãƒ¼ãƒ‰</option>
  <option value="close">é–‰åº—å¾Œãƒ¢ãƒ¼ãƒ‰</option>
</select>

<input id="date" type="date" />
<input id="machine" placeholder="å°ç•ªå·" type="number" />
<input id="games" placeholder="ç·å›è»¢æ•°" type="number" />
<input id="bb" placeholder="BBå›æ•°" type="number" />
<input id="rb" placeholder="RBå›æ•°" type="number" />

<button class="save" onclick="saveData()">ä¿å­˜</button>
<button class="clear" onclick="clearData()">å±¥æ­´ã‚’å…¨å‰Šé™¤</button>

<h2>åˆ†æçµæœ</h2>
<div id="list"></div>

<script>
let data = JSON.parse(localStorage.getItem("hanahanaData")) || [];

const settings = [
  { s: 1, rb: 496, all: 168 },
  { s: 2, rb: 467, all: 163 },
  { s: 3, rb: 439, all: 156 },
  { s: 4, rb: 405, all: 149 },
  { s: 5, rb: 374, all: 141 },
  { s: 6, rb: 343, all: 134 }
];

// ä»Šæ—¥ã®æ—¥ä»˜ã‚’è‡ªå‹•ã‚»ãƒƒãƒˆ
document.getElementById("date").value =
  new Date().toISOString().split("T")[0];

function saveData() {
  const date = document.getElementById("date").value;
  const machine = Number(document.getElementById("machine").value);
  const games = Number(document.getElementById("games").value);
  const bb = Number(document.getElementById("bb").value);
  const rb = Number(document.getElementById("rb").value);

  if (!date || !machine || !games || bb < 0 || rb < 0) {
    alert("å…¨éƒ¨å…¥åŠ›ã—ã¦ã­");
    return;
  }

  data.push({ date, machine, games, bb, rb });
  localStorage.setItem("hanahanaData", JSON.stringify(data));
  render();
}

function clearData() {
  if (!confirm("å±¥æ­´ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  data = [];
  localStorage.removeItem("hanahanaData");
  render();
}

/* ===== BBæœ€ä½æ¡ä»¶ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ===== */
function invalidData(games, bb, mode) {
  if (mode === "close" && bb === 0) return true;
  if (games >= 5000 && bb < 8) return true;
  if (games >= 4000 && bb < 5) return true;
  if (games >= 3000 && bb < 3) return true;
  return false;
}

function estimateSetting(games, bb, rb, mode) {
  if (rb === 0) return 0;
  if (invalidData(games, bb, mode)) return 0;

  const rbRate = games / rb;
  const allRate = games / (bb + rb);

  let best = 0;
  let bestScore = Infinity;

  settings.forEach(st => {
    const score =
      Math.abs(rbRate - st.rb) * 2 +
      Math.abs(allRate - st.all);
    if (score < bestScore) {
      bestScore = score;
      best = st.s;
    }
  });

  return best;
}

function confidence(games, rb, mode) {
  if (mode === "close") {
    if (games >= 5000 && rb >= 25) return "â˜…â˜…â˜…â˜…â˜…";
    if (games >= 4500 && rb >= 22) return "â˜…â˜…â˜…â˜…â˜†";
    if (games >= 4000 && rb >= 18) return "â˜…â˜…â˜…â˜†â˜†";
    if (games >= 3000 && rb >= 14) return "â˜…â˜…â˜†â˜†â˜†";
  } else {
    if (games >= 3000 && rb >= 15) return "â˜…â˜…â˜…â˜…â˜…";
    if (games >= 2500 && rb >= 12) return "â˜…â˜…â˜…â˜…â˜†";
    if (games >= 2000 && rb >= 9) return "â˜…â˜…â˜…â˜†â˜†";
    if (games >= 1000 && rb >= 5) return "â˜…â˜…â˜†â˜†â˜†";
  }
  return "â˜…â˜†â˜†â˜†â˜†";
}

function starCount(stars) {
  return stars.replace(/â˜†/g, "").length;
}

function render() {
  const list = document.getElementById("list");
  const mode = document.getElementById("mode").value;
  list.innerHTML = "";

  data
    .sort((a, b) =>
      a.machine !== b.machine
        ? a.machine - b.machine
        : a.date.localeCompare(b.date)
    )
    .forEach(d => {
      const total = d.bb + d.rb;
      const gassan = total ? Math.floor(d.games / total) : "-";
      const rbRate = d.rb ? Math.floor(d.games / d.rb) : "-";

      const setting = estimateSetting(d.games, d.bb, d.rb, mode);
      const conf = confidence(d.games, d.rb, mode);
      const aim =
        setting >= 4 &&
        starCount(conf) >= 4 &&
        setting !== 0;

      const card = document.createElement("div");
      card.className = "card" + (aim ? " aim" : "");

      card.innerHTML = `
        <div class="small">${d.date}</div>
        <div>å°ç•ªå·ï¼š${d.machine}</div>
        <div>${d.games}G / BB:${d.bb} RB:${d.rb}</div>
        <div>åˆç®—ï¼š1/${gassan}</div>
        <div>RBï¼š1/${rbRate}</div>
        <div class="red">æ¨å®šè¨­å®šï¼š${setting === 0 ? "åˆ¤åˆ¥ä¸å¯" : setting}</div>
        <div class="${setting === 0 ? "gray" : ""}">ä¿¡é ¼åº¦ï¼š${conf}</div>
        ${aim ? `<div class="aim-label">ğŸ”¥ ç‹™ã„ç›®</div>` : ""}
      `;
      list.appendChild(card);
    });
}

render();
</script>
</body>
</html>
