<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒãƒŠãƒãƒŠè¨­å®šåˆ¤åˆ¥</title>
  <style>
    body { font-family: sans-serif; background:#f5f5f5; padding:10px; }
    h1,h2 { margin:10px 0; }
    input,select,button { width:100%; padding:8px; margin:5px 0; font-size:16px; }
    button { background:#333; color:#fff; border:none; border-radius:4px; }
    .card {
      background:#fff; padding:10px; margin:10px 0;
      border-radius:6px; box-shadow:0 2px 5px rgba(0,0,0,.1);
    }
    .small { font-size:12px; color:#666; }
    .red { color:#d00; font-weight:bold; }
    .aim-label {
      background:gold; padding:4px; text-align:center;
      margin-top:6px; border-radius:4px; font-weight:bold;
    }
    .delete { background:#c00; margin-top:6px; }
  </style>
</head>
<body>

<h1>ğŸŒº ãƒãƒŠãƒãƒŠè¨­å®šåˆ¤åˆ¥</h1>

<!-- â˜… ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼šå¤‰æ›´æ™‚ã«å³å†æç”» -->
<select id="mode" onchange="render()">
  <option value="open">å–¶æ¥­ä¸­ãƒ¢ãƒ¼ãƒ‰</option>
  <option value="close">é–‰åº—å¾Œãƒ¢ãƒ¼ãƒ‰</option>
</select>

<input id="date" type="date">
<input id="machine" type="number" placeholder="å°ç•ªå·">
<input id="games" type="number" placeholder="ç·å›è»¢æ•°">
<input id="bb" type="number" placeholder="BBå›æ•°">
<input id="rb" type="number" placeholder="RBå›æ•°">

<button onclick="saveData()">ä¿å­˜</button>

<h2>ğŸ“‹ å°ãƒ‡ãƒ¼ã‚¿</h2>
<div id="list"></div>

<h2>ğŸª ãƒ›ãƒ¼ãƒ«å‚¾å‘åˆ†æ</h2>
<div id="hall"></div>

<script>
let data = JSON.parse(localStorage.getItem("hanahanaData")) || [];

/* ===== ä¿å­˜ ===== */
function saveData() {
  const d = {
    date: document.getElementById("date").value,
    machine: Number(document.getElementById("machine").value),
    games: Number(document.getElementById("games").value),
    bb: Number(document.getElementById("bb").value),
    rb: Number(document.getElementById("rb").value)
  };
  if (!d.date || !d.machine || !d.games) {
    alert("æœªå…¥åŠ›ãŒã‚ã‚Šã¾ã™");
    return;
  }
  data.push(d);
  localStorage.setItem("hanahanaData", JSON.stringify(data));
  render();
}

/* ===== è¨­å®šæ¨å®šï¼ˆå–¶æ¥­ä¸­ã¯å³ã—ã‚ï¼‰ ===== */
function estimateSetting(g, bb, rb, mode) {
  if (mode === "open" && g < 1500) return 0;
  if (mode === "close" && g < 3000) return 0;

  const rbRate = g / rb;

  if (rbRate < 220) return mode === "open" && g < 3000 ? 4 : 6;
  if (rbRate < 250) return mode === "open" ? 4 : 5;
  if (rbRate < 280) return 4;
  if (rbRate < 330) return 3;
  if (rbRate < 400) return 2;
  return 1;
}

/* ===== ä¿¡é ¼åº¦ ===== */
function confidence(g, rb, mode) {
  if (mode === "close") {
    if (g >= 7000) return "â˜…â˜…â˜…â˜…â˜…";
    if (g >= 5000) return "â˜…â˜…â˜…â˜…â˜†";
    if (g >= 3500) return "â˜…â˜…â˜…â˜†â˜†";
    return "â˜…â˜…â˜†â˜†â˜†";
  } else {
    if (g >= 3000) return "â˜…â˜…â˜…â˜†â˜†";
    if (g >= 2000) return "â˜…â˜…â˜†â˜†â˜†";
    return "â˜…â˜†â˜†â˜†â˜†";
  }
}

function starCount(s) {
  return (s.match(/â˜…/g) || []).length;
}

/* ===== å‰Šé™¤ ===== */
function deleteData(i) {
  if (!confirm("å‰Šé™¤ã™ã‚‹ï¼Ÿ")) return;
  data.splice(i, 1);
  localStorage.setItem("hanahanaData", JSON.stringify(data));
  render();
}

/* ===== ãƒ›ãƒ¼ãƒ«å‚¾å‘ ===== */
function analyzeHallTrend() {
  let keep=0, up=0, down=0, unknown=0;

  const sorted = [...data].sort((a,b)=>
    a.machine !== b.machine ? a.machine-b.machine : a.date.localeCompare(b.date)
  );

  for (let i=1;i<sorted.length;i++) {
    const t = sorted[i], y = sorted[i-1];
    if (t.machine !== y.machine) continue;

    const ts = estimateSetting(t.games,t.bb,t.rb,"close");
    const ys = estimateSetting(y.games,y.bb,y.rb,"close");

    if (!ts || !ys) unknown++;
    else if (ys>=4 && ts>=4) keep++;
    else if (ys<=2 && ts>=4) up++;
    else if (ys>=4 && ts<=2) down++;
    else unknown++;
  }

  const total = keep+up+down+unknown || 1;
  let type="å‚¾å‘ä¸æ˜";
  if (keep/total>=0.5) type="ğŸŸ§ æ®ãˆç½®ãé‡è¦–åº—";
  else if (up/total>=0.3) type="ğŸŸ© ä¸Šã’ç‹™ã„æœ‰åŠ¹åº—";
  else if (down/total>=0.3) type="ğŸŸ¥ ä¸‹ã’å¤šã‚æ³¨æ„åº—";

  return {keep,up,down,unknown,total,type};
}

/* ===== æç”» ===== */
function render() {
  const mode = document.getElementById("mode").value;
  const list = document.getElementById("list");
  list.innerHTML = "";

  data.forEach((d,i)=>{
    const total = d.bb + d.rb;
    const gassan = total ? Math.floor(d.games / total) : "-";
    const rbRate = d.rb ? Math.floor(d.games / d.rb) : "-";

    const set = estimateSetting(d.games,d.bb,d.rb,mode);
    const conf = confidence(d.games,d.rb,mode);

    // ğŸ”¥ ç‹™ã„ç›®ã¯ã€Œé–‰åº—å¾ŒåŸºæº–ã€ã§å›ºå®š
    const aim =
      estimateSetting(d.games,d.bb,d.rb,"close") >= 4 &&
      starCount(confidence(d.games,d.rb,"close")) >= 4;

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="small">${d.date}</div>
      <div>å°ç•ªå·ï¼š${d.machine}</div>
      <div>${d.games}G / BB:${d.bb} RB:${d.rb}</div>
      <div>åˆç®—ï¼š1/${gassan}</div>
      <div>RBï¼š1/${rbRate}</div>
      <div class="red">æ¨å®šè¨­å®šï¼š${set || "åˆ¤åˆ¥ä¸å¯"}</div>
      <div>ä¿¡é ¼åº¦ï¼š${conf}</div>
      ${aim ? `<div class="aim-label">ğŸ”¥ ç‹™ã„ç›®</div>` : ""}
      <button class="delete" onclick="deleteData(${i})">å‰Šé™¤</button>
    `;
    list.appendChild(card);
  });

  const hall = analyzeHallTrend();
  document.getElementById("hall").innerHTML = `
    <div class="card">
      <div>æ®ãˆï¼š${hall.keep}</div>
      <div>ä¸Šã’ï¼š${hall.up}</div>
      <div>ä¸‹ã’ï¼š${hall.down}</div>
      <div>ä¸å¯ï¼š${hall.unknown}</div>
      <div class="red">${hall.type}</div>
    </div>
  `;
}

render();
</script>

</body>
</html>
