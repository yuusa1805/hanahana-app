<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ハナハナ設定判別</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    select, input, button {
      width: 100%;
      padding: 14px;
      margin-top: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    button.save {
      background: #ff5a5a;
      color: white;
      border: none;
    }
    button.clear {
      background: #999;
      color: white;
      border: none;
    }
    .card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
    }
    .red {
      color: red;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <h1>ハナハナ設定判別</h1>

  <!-- 判断モード -->
  <select id="mode" onchange="render()">
    <option value="open">営業中モード</option>
    <option value="close">閉店後モード</option>
  </select>

  <input id="machine" placeholder="台番号" type="number" />
  <input id="games" placeholder="総回転数" type="number" />
  <input id="bb" placeholder="BB回数" type="number" />
  <input id="rb" placeholder="RB回数" type="number" />

  <button class="save" onclick="saveData()">保存</button>
  <button class="clear" onclick="clearData()">履歴を全削除</button>

  <h2>分析結果</h2>
  <div id="list"></div>

  <script>
    let data = JSON.parse(localStorage.getItem("hanahanaData")) || [];

    // 設定ごとの理論値（簡易）
    const settings = [
      { s: 1, rb: 496, all: 168 },
      { s: 2, rb: 467, all: 163 },
      { s: 3, rb: 439, all: 156 },
      { s: 4, rb: 405, all: 149 },
      { s: 5, rb: 374, all: 141 },
      { s: 6, rb: 343, all: 134 }
    ];

    function saveData() {
      const machine = document.getElementById("machine").value;
      const games = Number(document.getElementById("games").value);
      const bb = Number(document.getElementById("bb").value);
      const rb = Number(document.getElementById("rb").value);

      if (!machine || !games || !bb || !rb) {
        alert("全部入力してね");
        return;
      }

      data.push({ machine, games, bb, rb });
      localStorage.setItem("hanahanaData", JSON.stringify(data));
      render();
    }

    function clearData() {
      if (!confirm("履歴を全て削除しますか？")) return;
      data = [];
      localStorage.removeItem("hanahanaData");
      render();
    }

    // 設定推定（RB重視＋合算補助）
    function estimateSetting(games, bb, rb) {
      if (rb === 0) return "判別不可";

      const rbRate = games / rb;
      const allRate = games / (bb + rb);

      let best = null;
      let bestScore = Infinity;

      settings.forEach(st => {
        const rbDiff = Math.abs(rbRate - st.rb);
        const allDiff = Math.abs(allRate - st.all);
        const score = rbDiff * 2 + allDiff;

        if (score < bestScore) {
          bestScore = score;
          best = st.s;
        }
      });

      return best;
    }

    // 営業中用（甘め）
    function confidenceOpen(games, rb) {
      if (games >= 3000 && rb >= 15) return "★★★★★";
      if (games >= 2500 && rb >= 12) return "★★★★☆";
      if (games >= 2000 && rb >= 9) return "★★★☆☆";
      if (games >= 1000 && rb >= 5) return "★★☆☆☆";
      return "★☆☆☆☆";
    }

    // 閉店後用（超厳格）
    function confidenceClose(games, rb) {
      if (games >= 5000 && rb >= 25) return "★★★★★";
      if (games >= 4500 && rb >= 22) return "★★★★☆";
      if (games >= 4000 && rb >= 18) return "★★★☆☆";
      if (games >= 3000 && rb >= 14) return "★★☆☆☆";
      return "★☆☆☆☆";
    }

    function render() {
      const list = document.getElementById("list");
      const mode = document.getElementById("mode").value;
      list.innerHTML = "";

      data.forEach(d => {
        const totalBonus = d.bb + d.rb;
        const gassan = totalBonus > 0 ? Math.floor(d.games / totalBonus) : "-";
        const rbRate = d.rb > 0 ? Math.floor(d.games / d.rb) : "-";
        const setting = estimateSetting(d.games, d.bb, d.rb);

        const confidence =
          mode === "open"
            ? confidenceOpen(d.games, d.rb)
            : confidenceClose(d.games, d.rb);

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div>台番号：${d.machine}</div>
          <div>${d.games}G / BB:${d.bb} RB:${d.rb}</div>
          <div>合算：1/${gassan}</div>
          <div>RB：1/${rbRate}</div>
          <div class="red">推定設定：${setting}</div>
          <div>信頼度：${confidence}</div>
        `;
        list.appendChild(card);
      });
    }

    render();
  </script>
</body>
</html>
