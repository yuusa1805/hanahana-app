<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ãƒãƒŠãƒãƒŠè¨­å®šåˆ¤åˆ¥</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f5f5f5;
  padding: 20px;
}
h1 { text-align: center; }

select, input, button {
  width: 100%;
  padding: 14px;
  margin-top: 10px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

button.save {
  background: #ff5a5a;
  color: white;
  border: none;
}
button.clear {
  background: #888;
  color: white;
  border: none;
}

.card {
  background: white;
  padding: 15px;
  border-radius: 10px;
  margin-top: 15px;
  border: 2px solid transparent;
}
.aim {
  border-color: red;
  background: #fff0f0;
}
.keep {
  border-color: orange;
  background: #fff7e6;
}
.up {
  border-color: green;
  background: #eaffea;
}

.label {
  font-weight: bold;
  margin-top: 6px;
}
.red { color: red; font-weight: bold; }
.orange { color: orange; }
.green { color: green; }
.gray { color: #777; }
.small { font-size: 13px; color: #666; }
</style>
</head>

<body>
<h1>ãƒãƒŠãƒãƒŠè¨­å®šåˆ¤åˆ¥</h1>

<select id="mode" onchange="render()">
  <option value="open">å–¶æ¥­ä¸­ãƒ¢ãƒ¼ãƒ‰</option>
  <option value="close">é–‰åº—å¾Œãƒ¢ãƒ¼ãƒ‰</option>
</select>

<input id="date" type="date" />
<input id="machine" placeholder="å°ç•ªå·" type="number" />
<input id="games" placeholder="ç·å›è»¢æ•°" type="number" />
<input id="bb" placeholder="BBå›æ•°" type="number" />
<input id="rb" placeholder="RBå›æ•°" type="number" />

<button class="save" onclick="saveData()">ä¿å­˜</button>
<button class="clear" onclick="clearData()">å±¥æ­´ã‚’å…¨å‰Šé™¤</button>

<h2>åˆ†æçµæœ</h2>
<div id="list"></div>

<script>
let data = JSON.parse(localStorage.getItem("hanahanaData")) || [];

const settings = [
  { s: 1, rb: 496, all: 168 },
  { s: 2, rb: 467, all: 163 },
  { s: 3, rb: 439, all: 156 },
  { s: 4, rb: 405, all: 149 },
  { s: 5, rb: 374, all: 141 },
  { s: 6, rb: 343, all: 134 }
];

document.getElementById("date").value =
  new Date().toISOString().split("T")[0];

function saveData() {
  const date = document.getElementById("date").value;
  const machine = Number(document.getElementById("machine").value);
  const games = Number(document.getElementById("games").value);
  const bb = Number(document.getElementById("bb").value);
  const rb = Number(document.getElementById("rb").value);

  if (!date || !machine || !games) {
    alert("å…¨éƒ¨å…¥åŠ›ã—ã¦ã­");
    return;
  }

  data.push({ date, machine, games, bb, rb });
  localStorage.setItem("hanahanaData", JSON.stringify(data));
  render();
}

function clearData() {
  if (!confirm("å±¥æ­´ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  data = [];
  localStorage.removeItem("hanahanaData");
  render();
}

function invalidData(games, bb, mode) {
  if (mode === "close" && bb === 0) return true;
  if (games >= 5000 && bb < 8) return true;
  if (games >= 4000 && bb < 5) return true;
  if (games >= 3000 && bb < 3) return true;
  return false;
}

function estimateSetting(games, bb, rb, mode) {
  if (rb === 0) return 0;
  if (invalidData(games, bb, mode)) return 0;

  const rbRate = games / rb;
  const allRate = games / (bb + rb);

  let best = 0;
  let bestScore = Infinity;

  settings.forEach(st => {
    const score =
      Math.abs(rbRate - st.rb) * 2 +
      Math.abs(allRate - st.all);
    if (score < bestScore) {
      bestScore = score;
      best = st.s;
    }
  });
  return best;
}

function confidence(games, rb, mode) {
  if (mode === "close") {
    if (games >= 5000 && rb >= 25) return 5;
    if (games >= 4500 && rb >= 22) return 4;
    if (games >= 4000 && rb >= 18) return 3;
    if (games >= 3000 && rb >= 14) return 2;
  } else {
    if (games >= 3000 && rb >= 15) return 5;
    if (games >= 2500 && rb >= 12) return 4;
    if (games >= 2000 && rb >= 9) return 3;
    if (games >= 1000 && rb >= 5) return 2;
  }
  return 1;
}

function judgeTrend(today, yesterday) {
  if (!yesterday) return null;
  if (today.setting === 0 || yesterday.setting === 0) return "åˆ¤åˆ¥ä¸å¯";

  if (yesterday.setting >= 4 && today.setting >= 4)
    return "æ®ãˆç½®ãæ¿ƒåš";

  if (yesterday.setting <= 2 && today.setting >= 4)
    return "ä¸Šã’æ¿ƒåš";

  if (yesterday.setting >= 4 && today.setting <= 2)
    return "ä¸‹ã’æ¿ƒåš";

  return "ä¸æ˜";
}

function render() {
  const list = document.getElementById("list");
  const mode = document.getElementById("mode").value;
  list.innerHTML = "";

  const sorted = [...data].sort((a, b) =>
    a.machine !== b.machine
      ? a.machine - b.machine
      : a.date.localeCompare(b.date)
  );

  sorted.forEach((d, i) => {
    const total = d.bb + d.rb;
    const gassan = total ? Math.floor(d.games / total) : "-";
    const rbRate = d.rb ? Math.floor(d.games / d.rb) : "-";

    const setting = estimateSetting(d.games, d.bb, d.rb, mode);
    const conf = confidence(d.games, d.rb, mode);

    const yesterday =
      sorted[i - 1] &&
      sorted[i - 1].machine === d.machine
        ? sorted[i - 1]
        : null;

    const trend = judgeTrend(
      { setting },
      yesterday
        ? {
            setting: estimateSetting(
              yesterday.games,
              yesterday.bb,
              yesterday.rb,
              mode
            )
          }
        : null
    );

    let cls = "card";
    if (trend === "æ®ãˆç½®ãæ¿ƒåš") cls += " keep";
    if (trend === "ä¸Šã’æ¿ƒåš") cls += " up";

    const card = document.createElement("div");
    card.className = cls;

    card.innerHTML = `
      <div class="small">${d.date}</div>
      <div>å°ç•ªå·ï¼š${d.machine}</div>
      <div>${d.games}G / BB:${d.bb} RB:${d.rb}</div>
      <div>åˆç®—ï¼š1/${gassan}ã€€RBï¼š1/${rbRate}</div>
      <div class="red">æ¨å®šè¨­å®šï¼š${setting === 0 ? "åˆ¤åˆ¥ä¸å¯" : setting}</div>
      <div>ä¿¡é ¼åº¦ï¼š${"â˜…".repeat(conf)}${"â˜†".repeat(5 - conf)}</div>
      ${
        trend
          ? `<div class="label ${
              trend === "æ®ãˆç½®ãæ¿ƒåš"
                ? "orange"
                : trend === "ä¸Šã’æ¿ƒåš"
                ? "green"
                : "gray"
            }">ğŸ”® ${trend}</div>`
          : ""
      }
    `;
    list.appendChild(card);
  });
}

render();
</script>
</body>
</html>
